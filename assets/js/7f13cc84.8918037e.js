"use strict";(self.webpackChunkopen_8gu=self.webpackChunkopen_8gu||[]).push([[8237],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>m});var r=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=r.createContext({}),c=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=c(e.components);return r.createElement(l.Provider,{value:n},e.children)},d="mdxType",g={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},y=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(t),y=a,m=d["".concat(l,".").concat(y)]||d[y]||g[y]||o;return t?r.createElement(m,s(s({ref:n},p),{},{components:t})):r.createElement(m,s({ref:n},p))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,s=new Array(o);s[0]=y;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i[d]="string"==typeof e?e:a,s[1]=i;for(var c=2;c<o;c++)s[c]=t[c];return r.createElement.apply(null,s)}return r.createElement.apply(null,t)}y.displayName="MDXCreateElement"},7412:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>y,frontMatter:()=>s,metadata:()=>l,toc:()=>p});var r=t(7462),a=(t(7294),t(3905)),o=t(9962);const s={id:"kvy93gg3n2lyfkgd",sidebar_position:80,title:"Spring\u5bb9\u5668\u7684\u542f\u52a8\u8fc7\u7a0b\uff1f"},i=void 0,l={unversionedId:"spring/kvy93gg3n2lyfkgd",id:"spring/kvy93gg3n2lyfkgd",title:"Spring\u5bb9\u5668\u7684\u542f\u52a8\u8fc7\u7a0b\uff1f",description:"\u9762\u8bd5\u8bdd\u672f",source:"@site/framework/spring/80.Spring\u5bb9\u5668\u7684\u542f\u52a8\u8fc7\u7a0b\uff1f.md",sourceDirName:"spring",slug:"/spring/kvy93gg3n2lyfkgd",permalink:"/framework/spring/kvy93gg3n2lyfkgd",draft:!1,tags:[],version:"current",sidebarPosition:80,frontMatter:{id:"kvy93gg3n2lyfkgd",sidebar_position:80,title:"Spring\u5bb9\u5668\u7684\u542f\u52a8\u8fc7\u7a0b\uff1f"},sidebar:"community",previous:{title:"@Configuration\u548c@Component\u6709\u4ec0\u4e48\u533a\u522b\uff1f",permalink:"/framework/spring/gaudxa9kfs8gwdzs"},next:{title:"\u4ec0\u4e48\u662fBeanFactory\uff1f",permalink:"/framework/spring/czah4zwbmyng0qp7"}},c={},p=[{value:"\u9762\u8bd5\u8bdd\u672f",id:"\u9762\u8bd5\u8bdd\u672f",level:2},{value:"\u95ee\u9898\u8be6\u89e3",id:"\u95ee\u9898\u8be6\u89e3",level:2},{value:"1. \u521d\u59cb\u5316\u4e0a\u4e0b\u6587",id:"1-\u521d\u59cb\u5316\u4e0a\u4e0b\u6587",level:3},{value:"2. \u521d\u59cb\u5316 BeanFactory",id:"2-\u521d\u59cb\u5316-beanfactory",level:3},{value:"2.1. \u521b\u5efa\u5b9e\u4f8b",id:"21-\u521b\u5efa\u5b9e\u4f8b",level:4},{value:"2.2. \u5b8c\u6210\u51c6\u5907\u5de5\u4f5c",id:"22-\u5b8c\u6210\u51c6\u5907\u5de5\u4f5c",level:4},{value:"2.3. \u540e\u5904\u7406",id:"23-\u540e\u5904\u7406",level:4},{value:"2.4. \u5e94\u7528 BeanFactoryPostProcessor",id:"24-\u5e94\u7528-beanfactorypostprocessor",level:4},{value:"2.5. \u6ce8\u518c BeanPostProcessor",id:"25-\u6ce8\u518c-beanpostprocessor",level:4},{value:"3. \u521d\u59cb\u5316\u5176\u4ed6\u7ec4\u4ef6",id:"3-\u521d\u59cb\u5316\u5176\u4ed6\u7ec4\u4ef6",level:3},{value:"3.1. \u521d\u59cb\u5316\u6d88\u606f\u6e90",id:"31-\u521d\u59cb\u5316\u6d88\u606f\u6e90",level:4},{value:"3.2. \u521d\u59cb\u5316\u5e7f\u64ad\u5668",id:"32-\u521d\u59cb\u5316\u5e7f\u64ad\u5668",level:4},{value:"3.3. \u6ce8\u518c\u76d1\u542c\u5668",id:"33-\u6ce8\u518c\u76d1\u542c\u5668",level:4},{value:"4. \u9884\u52a0\u8f7d\u6240\u6709\u5355\u4f8b Bean",id:"4-\u9884\u52a0\u8f7d\u6240\u6709\u5355\u4f8b-bean",level:3},{value:"5. \u5b8c\u6210\u5237\u65b0",id:"5-\u5b8c\u6210\u5237\u65b0",level:3},{value:"5.1. \u6e05\u7a7a\u4e0a\u4e0b\u6587\u8d44\u6e90\u7f13\u5b58",id:"51-\u6e05\u7a7a\u4e0a\u4e0b\u6587\u8d44\u6e90\u7f13\u5b58",level:4},{value:"5.2. \u89e6\u53d1\u4e0a\u4e0b\u6587\u7684\u751f\u547d\u5468\u671f\u56de\u8c03",id:"52-\u89e6\u53d1\u4e0a\u4e0b\u6587\u7684\u751f\u547d\u5468\u671f\u56de\u8c03",level:4},{value:"5.3. \u53d1\u5e03 ContextRefreshedEvent \u4e8b\u4ef6",id:"53-\u53d1\u5e03-contextrefreshedevent-\u4e8b\u4ef6",level:4},{value:"5.4. \u542f\u52a8 WebServer",id:"54-\u542f\u52a8-webserver",level:4}],d={toc:p},g="wrapper";function y(e){let{components:n,...t}=e;return(0,a.kt)(g,(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)(o.ZP,{mdxType:"CommonContent"}),(0,a.kt)("h2",{id:"\u9762\u8bd5\u8bdd\u672f"},"\u9762\u8bd5\u8bdd\u672f"),(0,a.kt)("p",null,"Spring \u5bb9\u5668\u7684\u542f\u52a8\u8fc7\u7a0b\u5b9e\u9645\u4e0a\u5c31\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"AbstractApplicationContext")," \u62bd\u8c61\u7c7b\u4e2d ",(0,a.kt)("inlineCode",{parentName:"p"},"refresh")," \u65b9\u6cd5\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u4e0d\u8003\u8651\u5f02\u5e38\u60c5\u51b5\uff0c\u4e00\u4e2a\u5bb9\u5668\u6b63\u5e38\u542f\u52a8\u7684\u8fc7\u7a0b\u5927\u81f4\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b",(0,a.kt)("strong",{parentName:"p"},"\u4e94\u4e2a\u9636\u6bb5"),"\uff1a"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u521d\u59cb\u5316\u4e0a\u4e0b\u6587"),"\uff1a\u5bf9\u5e94 ",(0,a.kt)("inlineCode",{parentName:"li"},"prepareRefresh"),"\u65b9\u6cd5\uff0c\u7528\u4e8e\u5b8c\u6210\u91cd\u7f6e\u4e0a\u4e0b\u6587\u6807\u5fd7\u4f4d\uff0c\u521d\u59cb\u5316\u914d\u7f6e\u6587\u4ef6\uff0c\u91cd\u7f6e\u65e9\u671f\u4e8b\u4ef6\u7f13\u5b58\u7b49\u5de5\u4f5c\u3002"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u521d\u59cb\u5316 BeanFactory"),"\uff1a",(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u521b\u5efa\u5b9e\u4f8b"),"\uff1a\u5373\u4e3a\u5f53\u524d\u91cd\u65b0\u521b\u5efa\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanFactory"),"\uff1b"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u5b8c\u6210\u51c6\u5907\u5de5\u4f5c"),"\uff1a\u4e3a\u65b0 ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanFactory")," \u5b9e\u4f8b\u8bbe\u7f6e\u4e00\u4e9b\u9ed8\u8ba4\u914d\u7f6e\uff0c\u5e76\u6dfb\u52a0\u4e00\u4e9b\u5fc5\u8981\u7684\u540e\u5904\u7406\u5668\uff1b"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u540e\u5904\u7406"),"\uff1a\u5411\u5de5\u5382\u6ce8\u518c\u4e00\u4e9b\u8bf8\u5982 ",(0,a.kt)("inlineCode",{parentName:"li"},"Scope")," \u3001\u8868\u8fbe\u5f0f\u89e3\u6790\u5668\u3001\u7c7b\u578b\u8f6c\u6362\u5668\u7b49\u5fc5\u8981\u7684\u57fa\u672c\u7ec4\u4ef6\uff1b"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u4f7f\u7528\u540e\u5904\u7406\u5668"),"\uff1a\u8c03\u7528 ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanFactoryPostProcessor")," \u5bf9\u5de5\u5382\u8fdb\u884c\u540e\u5904\u7406\u5668\uff0c\u5728\u8fd9\u4e2a\u9636\u6bb5\u5c06\u4f1a\u5411 BeanFactory \u6ce8\u518c\u5fc5\u8981\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanDefinition"),"\uff0c\u6211\u4eec\u7684\u914d\u7f6e\u7c7b\u5c31\u5728\u8fd9\u4e2a\u9636\u6bb5\u751f\u6548\uff1b"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u6ce8\u518c BeanPostProcessor"),"\uff1a\u4ece ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanFactory")," \u4e2d\u521b\u5efa\u5e76\u83b7\u53d6\u6240\u6709\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanPostProcessor"),"\uff0c\u7136\u540e\u5c06\u5176\u6ce8\u518c\u5230\u5de5\u5382\u4e2d\u3002"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u521d\u59cb\u5316\u5176\u4ed6\u7ec4\u4ef6"),"\uff1a",(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u521d\u59cb\u5316\u6d88\u606f\u6e90"),"\uff1a\u5c1d\u8bd5\u4ece\u5bb9\u5668\u4e2d\u83b7\u53d6\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"li"},"MessageSource"),"\uff0c\u5982\u679c\u6ca1\u6709\u5c31\u5efa\u4e00\u4e2a\u65b0\u7684\uff1b"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u521d\u59cb\u5316\u5e7f\u64ad\u5668"),"\uff1a\u5c1d\u8bd5\u4ece\u5bb9\u5668\u4e2d\u83b7\u53d6\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"li"},"ApplicationEventMulticaster"),"\uff0c\u5982\u679c\u6ca1\u6709\u5c31\u5efa\u4e00\u4e2a\u65b0\u7684\uff1b"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u6ce8\u518c\u6d88\u606f\u76d1\u542c\u5668"),"\uff1a\u5c06\u5bb9\u5668\u4e2d\u6240\u6709\u5b9e\u73b0\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"ApplicationListener")," \u63a5\u53e3\u7684 Bean \u90fd\u6ce8\u518c\u5230\u5e7f\u64ad\u5668\uff1b"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u9884\u52a0\u8f7d\u6240\u6709\u5355\u4f8b Bean"),"\uff1a\u52a0\u8f7d\u5bb9\u5668\u4e2d\u6240\u6709\u975e\u61d2\u52a0\u8f7d\u7684\u5355\u4f8b Bean \uff0c\u5e76\u89e6\u53d1 ",(0,a.kt)("inlineCode",{parentName:"li"},"SmartInitializingSingleton")," \u56de\u8c03\u63a5\u53e3\u3002"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u5b8c\u6210\u5237\u65b0"),"\uff1a",(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u6e05\u7a7a\u4e0a\u4e0b\u6587\u8d44\u6e90\u7f13\u5b58"),"\uff1b"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u89e6\u53d1 Lifecycle \u56de\u8c03"),"\uff1a\u4ece\u5bb9\u5668\u4e2d\u83b7\u53d6\u6240\u6709\u5b9e\u73b0\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"Lifecycle")," \u63a5\u53e3\u7684 Bean\uff0c\u7136\u540e\u8c03\u7528\u56de\u8c03\u65b9\u6cd5\uff1b"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u53d1\u5e03 ContextRefreshedEvent \u4e8b\u4ef6"),"\uff1b"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"\u542f\u52a8\u5185\u7f6e\u7684 Web \u5bb9\u5668"),"\uff08SpringBoot \u5e94\u7528\uff09\u3002")))),(0,a.kt)("h2",{id:"\u95ee\u9898\u8be6\u89e3"},"\u95ee\u9898\u8be6\u89e3"),(0,a.kt)("p",null,"\u5f53\u6211\u4eec\u63d0\u5230 Spring \u5bb9\u5668\u7684\u542f\u52a8\u8fc7\u7a0b\uff0c\u5176\u662f\u5c31\u662f\u6307 ",(0,a.kt)("inlineCode",{parentName:"p"},"AbstractApplicationContext")," \u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"refresh")," \u65b9\u6cd5\u7684\u6267\u884c\u8fc7\u7a0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'public void refresh() throws BeansException, IllegalStateException {\n    synchronized (this.startupShutdownMonitor) {\n        \n        // \u9884\u5148\u51c6\u5907\u8d44\u6e90\n        prepareRefresh();\n        \n        // \u521b\u5efa BeanFactory\n        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();\n\n        // \u51c6\u5907 BeanFactory\uff0c\u8bbe\u7f6e\u4e00\u4e9b\u57fa\u672c\u53c2\u6570\uff0c\u5e76\u6ce8\u518c\u57fa\u672c\u7ec4\u4ef6\n        prepareBeanFactory(beanFactory);\n\n        try {\n            // \u5bf9\u4e8e BeanFactory \u8bbe\u7f6e\u4e00\u4e9b\u57fa\u672c\u53c2\u6570\n            postProcessBeanFactory(beanFactory);\n\n            // \u8c03\u7528 BeanFactoryPostProcessor\n            invokeBeanFactoryPostProcessors(beanFactory);\n\n            // \u5411 BeanFactory \u6ce8\u518c BeanPostProcessor\n            registerBeanPostProcessors(beanFactory);\n\n            // \u521d\u59cb\u5316\u6d88\u606f\u6e90\uff0c\u7528\u4e8e\u56fd\u9645\u5316\n            initMessageSource();\n\n            // \u521d\u59cb\u5316\u6d88\u606f\u5e7f\u64ad\u5668\n            initApplicationEventMulticaster();\n\n            // \u7a7a\u5b9e\u73b0\n            onRefresh();\n\n            // \u6ce8\u518c\u4e8b\u4ef6\u76d1\u542c\u5668\n            registerListeners();\n\n            // \u521d\u59cb\u5316\u6240\u6709\u7684\u975e\u61d2\u52a0\u8f7d\u5355\u4f8b Bean\n            finishBeanFactoryInitialization(beanFactory);\n\n            // \u5b8c\u6210\u5237\u65b0\uff0c\u53d1\u9001\u5237\u65b0\u5b8c\u6210\u4e8b\u4ef6\n            finishRefresh();\n        }\n\n        catch (BeansException ex) {\n            if (logger.isWarnEnabled()) {\n                logger.warn("Exception encountered during context initialization - " +\n                        "cancelling refresh attempt: " + ex);\n            }\n\n            // \u9500\u6bc1 Bean\uff0c\u5e76\u91ca\u653e\u76f8\u5173\u8d44\u6e90\n            destroyBeans();\n\n            // \u5c06 active \u8bbe\u7f6e\u4e3a false\n            cancelRefresh(ex);\n\n            // Propagate exception to caller.\n            throw ex;\n        }\n\n        finally {\n            // \u91ca\u653e\u4e00\u4e9b\u7f13\u5b58\u7684\u8d44\u6e90\n            resetCommonCaches();\n        }\n    }\n}\n')),(0,a.kt)("p",null,"\u5ffd\u7565\u5f02\u5e38\u60c5\u51b5\uff0c\u603b\u7684\u6765\u8bf4\uff0c\u8fd9\u4e00\u4e2a\u65b9\u6cd5\u4e3b\u8981\u7684\u903b\u8f91\u53ef\u4ee5\u5206\u4e3a\u4e94\u90e8\u5206\uff1a"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\u521d\u59cb\u5316\u4e0a\u4e0b\u6587\uff1b"),(0,a.kt)("li",{parentName:"ol"},"\u521d\u59cb\u5316 BeanFactory\uff1b"),(0,a.kt)("li",{parentName:"ol"},"\u521d\u59cb\u5316\u5176\u4ed6\u4e0a\u4e0b\u6587\u7ec4\u4ef6\uff1b"),(0,a.kt)("li",{parentName:"ol"},"\u9884\u52a0\u8f7d\u6240\u6709\u975e\u61d2\u52a0\u8f7d\u7684\u5355\u4f8b Bean\uff1b"),(0,a.kt)("li",{parentName:"ol"},"\u6536\u5c3e\u5de5\u4f5c\uff0c\u91ca\u653e\u8d44\u6e90\uff0c\u89e6\u53d1\u56de\u8c03\u7b49\u7b49\u3002")),(0,a.kt)("h3",{id:"1-\u521d\u59cb\u5316\u4e0a\u4e0b\u6587"},"1. \u521d\u59cb\u5316\u4e0a\u4e0b\u6587"),(0,a.kt)("p",null,"\u8fd9\u4e00\u6b65\u5bf9\u5e94 ",(0,a.kt)("inlineCode",{parentName:"p"},"prepareRefresh")," \u65b9\u6cd5\uff0c\u7b80\u5355\u7684\u6765\u8bf4\uff0c\u5b83\u505a\u4e86\u4e09\u4ef6\u4e8b\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u91cd\u7f6e\u542f\u52a8\u6807\u5fd7\u4f4d"),"\uff1a\u5373\u91cd\u7f6e ",(0,a.kt)("inlineCode",{parentName:"li"},"closed")," \u548c ",(0,a.kt)("inlineCode",{parentName:"li"},"active")," \u5c5e\u6027\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u51c6\u5907\u914d\u7f6e\u6587\u4ef6"),"\uff1a\u5373\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"li"},"initPropertySources")," \u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u4e14\u6821\u9a8c\u662f\u5426\u6240\u6709\u5fc5\u8981\u7684\u914d\u7f6e\u90fd\u5b58\u5728\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u521d\u59cb\u5316\u4e8b\u4ef6\u914d\u7f6e"),"\uff1a\u5373\u91cd\u7f6e\u6240\u6709\u65e9\u671f\u4e8b\u4ef6\u76d1\u542c\u5668\uff0c\u5e76\u6e05\u7a7a\u5df2\u53d1\u5e03\u7684\u65e9\u671f\u4e8b\u4ef6\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'protected void prepareRefresh() {\n    // \u91cd\u7f6e active \u548c closed \u6807\u5fd7\u4f4d\n    this.startupDate = System.currentTimeMillis();\n    this.closed.set(false);\n    this.active.set(true);\n\n    if (logger.isDebugEnabled()) {\n        if (logger.isTraceEnabled()) {\n            logger.trace("Refreshing " + this);\n        }\n        else {\n            logger.debug("Refreshing " + getDisplayName());\n        }\n    }\n\n    // \u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\n    initPropertySources();\n\n    // \u6821\u9a8c\u914d\u7f6e\u662f\u5426\u6b63\u786e\n    getEnvironment().validateRequiredProperties();\n\n    // \u521d\u59cb\u5316\u65e9\u671f\u4e8b\u4ef6\u76d1\u542c\u5668\n    if (this.earlyApplicationListeners == null) {\n        this.earlyApplicationListeners = new LinkedHashSet<>(this.applicationListeners);\n    }\n    else {\n        // Reset local application listeners to pre-refresh state.\n        this.applicationListeners.clear();\n        this.applicationListeners.addAll(this.earlyApplicationListeners);\n    }\n\n    // \u521d\u59cb\u5316\u65e9\u671f\u4e8b\u4ef6\n    this.earlyApplicationEvents = new LinkedHashSet<>();\n}\n')),(0,a.kt)("p",null,"\u5728\u8fd9\u4e00\u6b65\u6e05\u7a7a\u7684\u662f\u201c\u65e9\u671f\u4e8b\u4ef6\u201d\uff08earlyApplicationEvent\uff09\u5217\u8868\u3002\u6240\u8c13\u7684 \u201c\u65e9\u671f\u4e8b\u4ef6\u201d\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u6307\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\u5c31\u5df2\u7ecf\u53d1\u5e03\u7684\u4e8b\u4ef6\u3002\u6b64\u65f6\u5bb9\u5668\u4e2d\u7684 Bean \u90fd\u8fd8\u6ca1\u6709\u88ab\u521b\u5efa\u51fa\u6765\uff0c\u56e0\u6b64\u6ca1\u6709\u4efb\u4f55\u76d1\u542c\u5668\u53ef\u4ee5\u54cd\u5e94\u8fd9\u4e9b\u53d1\u5e03\u7684\u4e8b\u4ef6\uff0c\u56e0\u6b64\u8fd9\u4e9b\u4e8b\u4ef6\u9700\u8981\u5ef6\u8fdf\u5230\u5fc5\u8981\u7684\u76d1\u542c\u5668\u52a0\u8f7d\u5b8c\u6bd5\u540e\u518d\u53d1\u9001\u3002"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u5173\u4e8e\u4e8b\u4ef6\u673a\u5236\uff0c\u5177\u4f53\u53ef\u4ee5\u53c2\u89c1\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://www.yuque.com/magestack/open8gu/qzihwvh83ht2gegt?view=doc_embed"},"\u4ec0\u4e48\u662f Spring \u7684\u4e8b\u4ef6\u673a\u5236\uff1f"))),(0,a.kt)("h3",{id:"2-\u521d\u59cb\u5316-beanfactory"},"2. \u521d\u59cb\u5316 BeanFactory"),(0,a.kt)("h4",{id:"21-\u521b\u5efa\u5b9e\u4f8b"},"2.1. \u521b\u5efa\u5b9e\u4f8b"),(0,a.kt)("p",null,"\u5bf9\u5e94 ",(0,a.kt)("inlineCode",{parentName:"p"},"obtainFreshBeanFactory")," \u65b9\u6cd5\uff0cSpring \u5c06\u4f1a\u91cd\u7f6e ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationContext")," \u4e2d\u6301\u6709\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"ConfigurableListableBeanFactory"),"\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'protected ConfigurableListableBeanFactory obtainFreshBeanFactory() {\n    refreshBeanFactory();\n    return getBeanFactory();\n}\n\n// \u7531 AbstractRefreshableApplicationContext \u5b9e\u73b0\n@Override\nprotected final void refreshBeanFactory() throws BeansException {\n    if (hasBeanFactory()) {\n        // \u9500\u6bc1\u6240\u6709 Bean\n        destroyBeans();\n        // \u5173\u95ed\u5de5\u5382\n        closeBeanFactory();\n    }\n    try {\n        // \u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5de5\u5382\n        DefaultListableBeanFactory beanFactory = createBeanFactory();\n        beanFactory.setSerializationId(getId());\n        customizeBeanFactory(beanFactory);\n        // \u52a0\u8f7d BeanDefinition\n        loadBeanDefinitions(beanFactory);\n        this.beanFactory = beanFactory;\n    }\n    catch (IOException ex) {\n        throw new ApplicationContextException("I/O error parsing bean definition source for " + getDisplayName(), ex);\n    }\n}\n')),(0,a.kt)("p",null,"\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u6709\u4e24\u70b9\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"createBeanFactory")," \u8fd9\u4e00\u6b65\u521b\u5efa\u7684\u5bf9\u8c61\u57fa\u672c\u90fd\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"DefaultListableBeanFactory"),"\uff0c\u5b83\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanFactory")," \u4f53\u7cfb\u4e0b\u7684\u6700\u4e0b\u7ea7\u5b9e\u73b0\u7c7b\uff0c\u51e0\u4e4e\u6240\u6709\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"ApplicationContext")," \u7528\u7684\u90fd\u662f\u5b83\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"loadBeanDefinitions"),"\uff1a\u8fd9\u4e00\u6b65\u5c06\u4f1a\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 BeanDefinition\uff0c\u9ed8\u8ba4\u4f1a\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"li"},"XmlBeanDefinitionReader")," \u8bfb\u53d6 XML \u6587\u4ef6\uff0c\u5728\u9ad8\u7248\u672c\u7684 Spring \u4e2d\u57fa\u672c\u4e0d\u4f1a\u7528\u5230\u4e86\u3002")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u5173\u4e8e BeanFactory\uff0c\u8bf7\u53c2\u89c1\uff1a",(0,a.kt)("a",{parentName:"p",href:"/framework/spring/czah4zwbmyng0qp7"},"\u2705 \u4ec0\u4e48\u662f BeanFactory\uff1f"))),(0,a.kt)("h4",{id:"22-\u5b8c\u6210\u51c6\u5907\u5de5\u4f5c"},"2.2. \u5b8c\u6210\u51c6\u5907\u5de5\u4f5c"),(0,a.kt)("p",null,"\u8fd9\u4e00\u6b65\u5bf9\u5e94 ",(0,a.kt)("inlineCode",{parentName:"p"},"prepareBeanFactory"),"\uff0c\u5728\u8fd9\u4e00\u6b65\u4e2d\uff0cSpring \u4e3a\u5c06\u8981\u4f7f\u7528\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory")," \u6ce8\u518c\u5fc5\u8981\u7684\u57fa\u672c\u7ec4\u4ef6\uff0c\u6bd4\u5982\u7c7b\u52a0\u8f7d\u5668\u3001\u8868\u8fbe\u5f0f\u89e3\u6790\u5668\uff0c\u8fd8\u6709\u5904\u7406\u5bb9\u5668\u5373 Aware \u6ce8\u89e3\u7684\u540e\u5904\u7406\u5668 ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationContextAwareProcessor"),"\u7b49\u7b49......"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) {\n    // Tell the internal bean factory to use the context's class loader etc.\n    beanFactory.setBeanClassLoader(getClassLoader());\n    beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));\n    beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment()));\n\n    // Configure the bean factory with context callbacks.\n    beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this));\n    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);\n    beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);\n    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);\n    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);\n    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);\n    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);\n\n    // \u6ce8\u518c\u65e0\u9700\u521b\u5efa\u7684\u7279\u6b8a Bean\uff0c\u4f9d\u8d56\u6ce8\u5165\u7684\u65f6\u5019\u4f1a\u76f4\u63a5\u62ff\u5230\u5f53\u524d\u8fd9\u91cc\u6307\u5b9a\u7684\u5bf9\u8c61\n    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);\n    beanFactory.registerResolvableDependency(ResourceLoader.class, this);\n    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this);\n    beanFactory.registerResolvableDependency(ApplicationContext.class, this);\n\n    // \u6ce8\u518c\u4e8b\u4ef6\u76d1\u542c\u5668\u68c0\u67e5\u5668\n    // Register early post-processor for detecting inner beans as ApplicationListeners.\n    beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this));\n\n    // Detect a LoadTimeWeaver and prepare for weaving, if found.\n    if (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {\n        beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));\n        // Set a temporary ClassLoader for type matching.\n        beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));\n    }\n\n    // Register default environment beans.\n    if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) {\n        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());\n    }\n    if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) {\n        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());\n    }\n    if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) {\n        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());\n    }\n}\n")),(0,a.kt)("blockquote",null,(0,a.kt)("ul",{parentName:"blockquote"},(0,a.kt)("li",{parentName:"ul"},"\u5173\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"ApplicationContextAwareProcessor"),"\u4e0e Aware \u63a5\u53e3\uff0c\u8bf7\u53c2\u89c1\uff1a",(0,a.kt)("a",{parentName:"li",href:"/framework/spring/cssibafmgio4g44c"},"\u2705 Bean \u7684\u751f\u547d\u5468\u671f\uff1f")),(0,a.kt)("li",{parentName:"ul"},"\u5173\u4e8e\u4e8b\u4ef6\u76d1\u542c\u5668\u68c0\u67e5\u5668 ",(0,a.kt)("inlineCode",{parentName:"li"},"ApplicationListenerDetector"),"\uff0c\u8bf7\u53c2\u89c1\uff1a",(0,a.kt)("a",{parentName:"li",href:"https://www.yuque.com/magestack/open8gu/qzihwvh83ht2gegt?view=doc_embed"},"\u4ec0\u4e48\u662f Spring \u7684\u4e8b\u4ef6\u673a\u5236\uff1f")))),(0,a.kt)("h4",{id:"23-\u540e\u5904\u7406"},"2.3. \u540e\u5904\u7406"),(0,a.kt)("p",null,"\u8fd9\u4e00\u6b65\u5bf9\u5e94 ",(0,a.kt)("inlineCode",{parentName:"p"},"postProcessBeanFactory")," \u65b9\u6cd5\uff0c\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"AbstractApplicationContext")," \u4e2d\u5b9e\u9645\u4e0a\u8be5\u65b9\u6cd5\u662f\u4e00\u4e2a\u7a7a\u65b9\u6cd5\uff0c\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"GenericWebApplicationContext")," \u7b49\u5b50\u7c7b\u624d\u6709\u5b9e\u73b0\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"// GenericWebApplicationContext\n@Override\nprotected void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {\n    beanFactory.addBeanPostProcessor(new ServletContextAwareProcessor(this.servletContext));\n    beanFactory.ignoreDependencyInterface(ServletContextAware.class);\n\n    WebApplicationContextUtils.registerWebApplicationScopes(beanFactory, this.servletContext);\n    WebApplicationContextUtils.registerEnvironmentBeans(beanFactory, this.servletContext);\n}\n\n// ServletWebServerApplicationContext\n@Override\nprotected void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {\n    beanFactory.addBeanPostProcessor(new WebApplicationContextServletContextAwareProcessor(this));\n    beanFactory.ignoreDependencyInterface(ServletContextAware.class);\n    registerWebApplicationScopes();\n}\n")),(0,a.kt)("p",null,"\u603b\u7684\u6765\u770b\uff0cWeb \u73af\u5883\u4e0b\u4f7f\u7528\u7684\u4e0a\u4e0b\u6587\u57fa\u672c\u90fd\u5b9e\u73b0\u4e86\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u5728\u8fd9\u4e00\u6b65\uff0c\u5b83\u4eec\u505a\u4e86\u4ee5\u4e0b\u51e0\u4ef6\u4e8b\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u6ce8\u518c Web \u73af\u5883\u4e0b\u7684\u51e0\u4e2a scope\uff1a request\u3001session \u548c application\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e Web \u73af\u5883\u4e0b\u7684\u7279\u6b8a Bean\uff1aServletRequest\u3001ServletResponse\u3001HeepSession\u3001WebRequest\u3002")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u987a\u5e26\u4e00\u63d0\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"ServletRequest")," \u548c ",(0,a.kt)("inlineCode",{parentName:"p"},"ServletResponse")," \u6bcf\u6b21\u4f7f\u7528\u7684\u65f6\u5019\u603b\u662f\u80fd\u62ff\u5230\u6700\u65b0\u7684\u503c\uff0c\u5176\u5b9e\u5c31\u662f\u56e0\u4e3a\u5728\u8fd9\u6307\u5b9a\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"ObjectFactory"),"\uff0c\u5177\u4f53\u5185\u5bb9\u53ef\u4ee5\u53c2\u89c1\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://www.yuque.com/magestack/open8gu/ol1pmt4pzwoayurg?view=doc_embed"},"\u4e3a\u4ec0\u4e48 HttpServletRequest \u6bcf\u6b21\u90fd\u53ef\u4ee5\u53d6\u5230\u6700\u65b0\u503c\uff1f"))),(0,a.kt)("h4",{id:"24-\u5e94\u7528-beanfactorypostprocessor"},"2.4. \u5e94\u7528 BeanFactoryPostProcessor"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"invokeBeanFactoryPostProcessors")," \u8fd9\u4e00\u6b65\u5c31\u662f\u91cd\u5934\u620f\u4e86\uff0c\u5728\u8fd9\u4e00\u4e2a\u65b9\u6cd5\u4e2d\uff0cSpring \u5c06\u4f1a\u52a0\u8f7d\u6240\u6709\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactorPostProcessor"),"\uff0c\u7136\u540e\u4f7f\u7528\u5b83\u5bf9 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory")," \u8fdb\u884c\u540e\u5904\u7406\u3002"),(0,a.kt)("p",null,"\u7531\u4e8e\u8fd9\u4e00\u6bb5\u4ee3\u7801\u975e\u5e38\u7684\u957f\uff0c\u6240\u4ee5\u8fd9\u91cc\u76f4\u63a5\u5148\u653e\u7ed3\u8bba\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u4e0d\u540c\u7c7b\u578b\u5904\u7406\u5668\u7684\u8c03\u7528\u987a\u5e8f"),"\uff1a",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"BeanDefinitionRegistryPostProcessor")," \u5148\u8c03\u7528\uff0c\u5b83\u901a\u5e38\u7528\u4e8e\u6ce8\u518c\u989d\u5916\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanDefinition"),"\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"BeanFactoryPostProcessor"),"\u540e\u8c03\u7528\u3002"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u540c\u7c7b\u578b\u5904\u7406\u5668\u7684\u8c03\u7528\u987a\u5e8f"),"\uff1a",(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"\u5148\u8c03\u7528\u5b9e\u73b0\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"PriorityOrdered")," \u63a5\u53e3\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanDefinitionRegistryPostProcessor"),"\uff1b"),(0,a.kt)("li",{parentName:"ol"},"\u518d\u8c03\u7528\u5b9e\u73b0\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"Ordered")," \u63a5\u53e3\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanDefinitionRegistryPostProcessor"),"\uff1b"),(0,a.kt)("li",{parentName:"ol"},"\u6700\u540e\u8c03\u7528\u6ca1\u6709\u5b9e\u73b0\u4e0a\u8ff0\u4e24\u63a5\u53e3\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanDefinitionRegistryPostProcessor"),"\u3002")))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) {\n    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());\n\n    // Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime\n    // (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)\n    if (beanFactory.getTempClassLoader() == null && beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {\n        beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));\n        beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));\n    }\n}\n\npublic static void invokeBeanFactoryPostProcessors(\n    ConfigurableListableBeanFactory beanFactory, List<BeanFactoryPostProcessor> beanFactoryPostProcessors) {\n\n    // Invoke BeanDefinitionRegistryPostProcessors first, if any.\n    Set<String> processedBeans = new HashSet<>();\n\n    // \u5982\u679cBeanFactory\u5b9e\u73b0\u4e86BeanDefinitionRegistry\u63a5\u53e3\n    if (beanFactory instanceof BeanDefinitionRegistry) {\n\n        // \u5c06\u540e\u7f6e\u5904\u7406\u5668\u5206\u4e3a\u4e24\u7c7b\uff1a\n        // 1.\u666e\u901a\u7684BeanFactoryPostProcessor;\n        // 2.BeanFactoryPostProcessor\u7684\u5b50\u7c7bBeanDefinitionRegistryPostProcessor;\n        BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;\n        List<BeanFactoryPostProcessor> regularPostProcessors = new ArrayList<>();\n        List<BeanDefinitionRegistryPostProcessor> registryProcessors = new ArrayList<>();\n        for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) {\n            if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) {\n                BeanDefinitionRegistryPostProcessor registryProcessor =\n                    (BeanDefinitionRegistryPostProcessor) postProcessor;\n                // \u82e5\u662fBeanDefinitionRegistryPostProcessor\uff0c\u5219\u5148\u8c03\u7528\u8be5\u7c7b\u7684postProcessBeanDefinitionRegistry\u65b9\u6cd5\n                registryProcessor.postProcessBeanDefinitionRegistry(registry);\n                registryProcessors.add(registryProcessor);\n            }\n            else {\n                regularPostProcessors.add(postProcessor);\n            }\n        }\n\n        // Do not initialize FactoryBeans here: We need to leave all regular beans\n        // uninitialized to let the bean factory post-processors apply to them!\n        // Separate between BeanDefinitionRegistryPostProcessors that implement\n        // PriorityOrdered, Ordered, and the rest.\n        List<BeanDefinitionRegistryPostProcessor> currentRegistryProcessors = new ArrayList<>();\n\n        // \u5148\u8c03\u7528\u5b9e\u73b0\u4e86PriorityOrdered\u63a5\u53e3\u7684BeanDefinitionRegistryPostProcessors\n        String[] postProcessorNames =\n            beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);\n        for (String ppName : postProcessorNames) {\n            if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {\n                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));\n                processedBeans.add(ppName);\n            }\n        }\n        sortPostProcessors(currentRegistryProcessors, beanFactory);\n        registryProcessors.addAll(currentRegistryProcessors);\n        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);\n        currentRegistryProcessors.clear();\n\n        // \u518d\u8c03\u7528\u5b9e\u73b0\u4e86Ordered\u63a5\u53e3\u7684BeanDefinitionRegistryPostProcessors\n        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);\n        for (String ppName : postProcessorNames) {\n            if (!processedBeans.contains(ppName) && beanFactory.isTypeMatch(ppName, Ordered.class)) {\n                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));\n                processedBeans.add(ppName);\n            }\n        }\n        sortPostProcessors(currentRegistryProcessors, beanFactory);\n        registryProcessors.addAll(currentRegistryProcessors);\n        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);\n        currentRegistryProcessors.clear();\n\n        // \u6700\u540e\u8c03\u7528\u6ca1\u5b9e\u73b0PriorityOrdered\u6216\u8005Ordered\u63a5\u53e3\u7684BeanDefinitionRegistryPostProcessors\n        boolean reiterate = true;\n        while (reiterate) {\n            reiterate = false;\n            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);\n            for (String ppName : postProcessorNames) {\n                if (!processedBeans.contains(ppName)) {\n                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));\n                    processedBeans.add(ppName);\n                    reiterate = true;\n                }\n            }\n            sortPostProcessors(currentRegistryProcessors, beanFactory);\n            registryProcessors.addAll(currentRegistryProcessors);\n            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);\n            currentRegistryProcessors.clear();\n        }\n\n        // Now, invoke the postProcessBeanFactory callback of all processors handled so far.\n        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);\n        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);\n    }\n\n    // \u5982\u679cBeanFactory\u6ca1\u6709\u5b9e\u73b0BeanDefinitionRegistry\u63a5\u53e3\n    else {\n        // Invoke factory processors registered with the context instance.\n        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);\n    }\n\n    // Do not initialize FactoryBeans here: We need to leave all regular beans\n    // uninitialized to let the bean factory post-processors apply to them!\n    String[] postProcessorNames =\n        beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false);\n\n    // \u8fc7\u6ee4\u6389\u5df2\u7ecf\u8c03\u7528\u8fc7\u7684\u5904\u7406\u5668\uff0c\u7136\u540e\u628a\u5904\u7406\u5668\u5206\u4e3a\u4e09\u7c7b\uff1a\n    // 1.\u5b9e\u73b0\u4e86PriorityOrdered\u63a5\u53e3\u7684\u5904\u7406\u5668;\n    // 2.\u5b9e\u73b0\u4e86Ordered\u63a5\u53e3\u7684\u5904\u7406\u5668;\n    // 3.\u6ca1\u6709\u5b9e\u73b0PriorityOrdered\u6216Ordered\u63a5\u53e3\u7684\u5904\u7406\u5668;\n    List<BeanFactoryPostProcessor> priorityOrderedPostProcessors = new ArrayList<>();\n    List<String> orderedPostProcessorNames = new ArrayList<>();\n    List<String> nonOrderedPostProcessorNames = new ArrayList<>();\n    for (String ppName : postProcessorNames) {\n        if (processedBeans.contains(ppName)) {\n            // skip - already processed in first phase above\n        }\n        else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {\n            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));\n        }\n        else if (beanFactory.isTypeMatch(ppName, Ordered.class)) {\n            orderedPostProcessorNames.add(ppName);\n        }\n        else {\n            nonOrderedPostProcessorNames.add(ppName);\n        }\n    }\n\n     // \u8c03\u7528\u5b9e\u73b0\u4e86PriorityOrdered\u63a5\u53e3\u7684\u540e\u7f6e\u5904\u7406\u5668\n    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);\n    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);\n\n    // \u8c03\u7528\u5b9e\u73b0\u4e86Ordered\u63a5\u53e3\u7684\u540e\u7f6e\u5904\u7406\u5668\n    List<BeanFactoryPostProcessor> orderedPostProcessors = new ArrayList<>(orderedPostProcessorNames.size());\n    for (String postProcessorName : orderedPostProcessorNames) {\n        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));\n    }\n    sortPostProcessors(orderedPostProcessors, beanFactory);\n    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);\n\n    // \u8c03\u7528\u6ca1\u6709\u5b9e\u73b0PriorityOrdered\u6216Ordered\u63a5\u53e3\u7684\u540e\u7f6e\u5904\u7406\u5668\n    List<BeanFactoryPostProcessor> nonOrderedPostProcessors = new ArrayList<>(nonOrderedPostProcessorNames.size());\n    for (String postProcessorName : nonOrderedPostProcessorNames) {\n        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));\n    }\n    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);\n\n    // \u6e05\u9664\u5143\u6570\u636e\n    beanFactory.clearMetadataCache();\n}\n")),(0,a.kt)("p",null,"\u5176\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u4e00\u4e0b ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanDefinitionRegistryPostProcessor")," \u8fd9\u4e2a\u540e\u5904\u7406\u5668\uff0c\u5b83\u5b9e\u9645\u4e0a\u662f ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactoryPostProcessor"),"\u7684\u5b50\u63a5\u53e3\uff0c\u5b83\u8fd0\u884c\u5bb9\u5668\u542f\u52a8\u4ee5\u540e\u52a8\u6001\u7684\u5411 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory")," \u6ce8\u518c\u989d\u5916\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanDefinition"),"\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u6211\u4eec\u975e\u5e38\u719f\u6089\u7684 ConfigurationClassPostProcessor \u5c31\u5b9e\u73b0\u4e86\u8fd9\u4e2a\u63a5\u53e3\uff0c\u5e26\u6709 @Bean \u6ce8\u89e3\u7684\u5de5\u5382\u65b9\u6cd5\u5bf9\u5e94\u7684 BeanDefinition \u5c31\u662f\u5728\u8fd9\u4e2a\u65f6\u5019\u6ce8\u518c\u5230\u5bb9\u5668\u7684\u3002")),(0,a.kt)("h4",{id:"25-\u6ce8\u518c-beanpostprocessor"},"2.5. \u6ce8\u518c BeanPostProcessor"),(0,a.kt)("p",null,"\u5f53\u5bf9 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory")," \u5e94\u7528\u540e\u5904\u7406\u4ee5\u540e\uff0c\u6b64\u65f6\u6240\u6709\u5fc5\u8981\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanDefinition")," \u2014\u2014 \u5305\u62ec ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanPostProcessor"),"\uff0c\u56e0\u4e3a\u5b83\u4eec\u672c\u8d28\u4e0a\u4e5f\u662f Bean \u2014\u2014 \u90fd\u5df2\u7ecf\u6ce8\u518c\u5230\u5bb9\u5668\u3002"),(0,a.kt)("p",null,"\u6b64\u65f6\u5219\u9700\u8981\u73b0\u5c06\u8fd9\u4e9b ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanPostProcessor")," \u521b\u5efa\u51fa\u6765\uff0c\u7136\u540e\u8bbe\u7f6e\u5230 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory"),"\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"protected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) {\n    PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);\n}\n\npublic static void registerBeanPostProcessors(\n    ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) {\n\n    String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false);\n\n    // Register BeanPostProcessorChecker that logs an info message when\n    // a bean is created during BeanPostProcessor instantiation, i.e. when\n    // a bean is not eligible for getting processed by all BeanPostProcessors.\n    int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length;\n    beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));\n\n    // \u4f9d\u7136\u5c06\u540e\u7f6e\u5904\u7406\u5668\u5206\u4e3a\u4e09\u7c7b\uff1a\n    // 1.\u5b9e\u73b0\u4e86PriorityOrdered\u63a5\u53e3\u7684\u5904\u7406\u5668;\n    // 2.\u5b9e\u73b0\u4e86Ordered\u63a5\u53e3\u7684\u5904\u7406\u5668;\n    // 3.\u6ca1\u6709\u5b9e\u73b0PriorityOrdered\u6216Ordered\u63a5\u53e3\u7684\u5904\u7406\u5668;\n    List<BeanPostProcessor> priorityOrderedPostProcessors = new ArrayList<>();\n    List<BeanPostProcessor> internalPostProcessors = new ArrayList<>();\n    List<String> orderedPostProcessorNames = new ArrayList<>();\n    List<String> nonOrderedPostProcessorNames = new ArrayList<>();\n    for (String ppName : postProcessorNames) {\n        if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {\n            BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);\n            priorityOrderedPostProcessors.add(pp);\n            // \u8fd9\u91cc\u662f\u7528\u4e8e\u6846\u67b6\u5185\u90e8\u4f7f\u7528\u7684\u540e\u7f6e\u5904\u7406\u5668\n            if (pp instanceof MergedBeanDefinitionPostProcessor) {\n                internalPostProcessors.add(pp);\n            }\n        }\n        else if (beanFactory.isTypeMatch(ppName, Ordered.class)) {\n            orderedPostProcessorNames.add(ppName);\n        }\n        else {\n            nonOrderedPostProcessorNames.add(ppName);\n        }\n    }\n\n    // \u6ce8\u518c\u5b9e\u73b0\u4e86PriorityOrdered\u63a5\u53e3\u7684\u540e\u7f6e\u5904\u7406\u5668\n    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);\n    registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);\n\n    // \u6ce8\u518c\u5b9e\u73b0\u4e86Ordered\u63a5\u53e3\u7684\u540e\u7f6e\u5904\u7406\u5668\n    List<BeanPostProcessor> orderedPostProcessors = new ArrayList<>(orderedPostProcessorNames.size());\n    for (String ppName : orderedPostProcessorNames) {\n        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);\n        orderedPostProcessors.add(pp);\n        if (pp instanceof MergedBeanDefinitionPostProcessor) {\n            internalPostProcessors.add(pp);\n        }\n    }\n    sortPostProcessors(orderedPostProcessors, beanFactory);\n    registerBeanPostProcessors(beanFactory, orderedPostProcessors);\n\n    // \u6ce8\u518c\u6ca1\u6709\u5b9e\u73b0PriorityOrdered\u6216Ordered\u63a5\u53e3\u7684\u540e\u7f6e\u5904\u7406\u5668\n    List<BeanPostProcessor> nonOrderedPostProcessors = new ArrayList<>(nonOrderedPostProcessorNames.size());\n    for (String ppName : nonOrderedPostProcessorNames) {\n        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);\n        nonOrderedPostProcessors.add(pp);\n        if (pp instanceof MergedBeanDefinitionPostProcessor) {\n            internalPostProcessors.add(pp);\n        }\n    }\n    registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);\n\n    // \u6ce8\u89e3\u6846\u67b6\u5185\u90e8\u4f7f\u7528\u7684\u540e\u7f6e\u5904\u7406\u5668\n    sortPostProcessors(internalPostProcessors, beanFactory);\n    registerBeanPostProcessors(beanFactory, internalPostProcessors);\n\n    // \u91cd\u65b0\u6ce8\u518cApplicationListenerDetector\uff0c\u4fdd\u8bc1\u8be5\u5904\u7406\u5668\u603b\u662f\u4f4d\u4e8e\u5904\u7406\u5668\u94fe\u7684\u6700\u540e\u4e00\u4f4d\uff0c\u4ece\u800c\u603b\u662f\u5728\u6700\u540e\u88ab\u6267\u884c\n    // \u8be5\u540e\u7f6e\u5904\u7406\u5668\u7528\u4e8e\u652f\u6301spring\u7684\u4e8b\u4ef6\u673a\u5236\n    beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));\n}\n")),(0,a.kt)("p",null,"\u8fd9\u91cc\u7684\u6392\u5e8f\u903b\u8f91\u4e0e\u8c03\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactoryPostProcessor")," \u662f\u57fa\u672c\u4e00\u81f4\u7684\uff0c\u4f46\u662f\u7531\u4e8e ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanPostProcessor")," \u7684\u7279\u6b8a\u6027\uff0c\u6211\u4eec\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\u51e0\u70b9\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"BeanPostProcessor \u672c\u8eab\u4e5f\u662f\u4e00\u4e2a Bean\uff0c\u56e0\u6b64\u4f1a\u88ab\u5176\u4ed6 BeanPostProcessor \u5904\u7406\u3002")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u6392\u5e8f\u9760\u540e\u7684 BeanPostProcessor \u4f1a\u88ab\u6392\u5e8f\u9760\u524d\u7684 BeanPostProcessor \u8fdb\u884c\u540e\u5904\u7406\uff0c\u56e0\u4e3a\u5b83\u66f4\u665a\u88ab\u521b\u5efa\u3002"))),(0,a.kt)("p",null,"\u5173\u4e8e\u4e0a\u8ff0\u4e24\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u7ed3\u5408\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\u53bb\u7406\u89e3\uff1a"),(0,a.kt)("p",null,"\u6211\u4eec\u90fd\u77e5\u9053\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationContextAware"),"\u8fd8\u6709 ",(0,a.kt)("inlineCode",{parentName:"p"},"@PostConstruct"),"\u6ce8\u89e3\u8fd9\u4e9b\u673a\u5236\u672c\u8eab\u90fd\u662f\u57fa\u4e8e ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanPostProcessor")," \u5b9e\u73b0\u7684\uff0c\u800c\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u5176\u4ed6 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanPostProcessor")," \u5374\u4f9d\u7136\u53ef\u4ee5\u4f7f\u7528 Aware \u63a5\u53e3\u6216\u8005 ",(0,a.kt)("inlineCode",{parentName:"p"},"@PostConstruct")," \u6ce8\u89e3\uff1f"),(0,a.kt)("p",null,"\u539f\u56e0\u5f88\u7b80\u5355\uff0c\u56e0\u4e3a\u5b83\u4eec\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationContextAwareProcessor")," \u4e4b\u540e\u521b\u5efa\uff0c\u6240\u4ee5\u4f1a\u88ab ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationContextAwareProcessor")," \u8fdb\u884c\u540e\u5904\u7406\u3002"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u5173\u4e8e ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationContextAware")," \u4e0e ",(0,a.kt)("inlineCode",{parentName:"p"},"@PostConstruct")," \u76f8\u5173\u7684\u5185\u5bb9\uff0c\u8bf7\u53c2\u89c1\uff1a",(0,a.kt)("a",{parentName:"p",href:"/framework/spring/cssibafmgio4g44c"},"\u2705 Bean \u7684\u751f\u547d\u5468\u671f\uff1f"))),(0,a.kt)("h3",{id:"3-\u521d\u59cb\u5316\u5176\u4ed6\u7ec4\u4ef6"},"3. \u521d\u59cb\u5316\u5176\u4ed6\u7ec4\u4ef6"),(0,a.kt)("p",null,"\u8fd9\u91cc\u7684\u5176\u4ed6\u7ec4\u4ef6\u4e3b\u8981\u662f\u6d88\u606f\u6e90\u3001\u4e8b\u4ef6\u5e7f\u64ad\u5668\u548c\u76d1\u542c\u5668\u8fd9\u51e0\u90e8\u5206\u3002"),(0,a.kt)("h4",{id:"31-\u521d\u59cb\u5316\u6d88\u606f\u6e90"},"3.1. \u521d\u59cb\u5316\u6d88\u606f\u6e90"),(0,a.kt)("p",null,"\u8fd9\u4e00\u6b65\u5bf9\u5e94 ",(0,a.kt)("inlineCode",{parentName:"p"},"initMessageSource")," \u65b9\u6cd5\uff0c\u6d88\u606f\u6e90\u4e3b\u8981\u7528\u4e8e\u56fd\u9645\u5316\u76f8\u5173\u7684\u529f\u80fd\uff0c\u8fd9\u4e00\u5757\u4e00\u822c\u95ee\u7684\u4e0d\u591a\uff0c\u56e0\u6b64\u7b80\u5355\u4e86\u89e3\u4e00\u4e0b\u5373\u53ef\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'protected void initMessageSource() {\n    ConfigurableListableBeanFactory beanFactory = getBeanFactory();\n    if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) {\n        this.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);\n        // Make MessageSource aware of parent MessageSource.\n        if (this.parent != null && this.messageSource instanceof HierarchicalMessageSource) {\n            HierarchicalMessageSource hms = (HierarchicalMessageSource) this.messageSource;\n            if (hms.getParentMessageSource() == null) {\n                // Only set parent context as parent MessageSource if no parent MessageSource\n                // registered already.\n                hms.setParentMessageSource(getInternalParentMessageSource());\n            }\n        }\n        if (logger.isTraceEnabled()) {\n            logger.trace("Using MessageSource [" + this.messageSource + "]");\n        }\n    }\n    else {\n        // Use empty MessageSource to be able to accept getMessage calls.\n        DelegatingMessageSource dms = new DelegatingMessageSource();\n        dms.setParentMessageSource(getInternalParentMessageSource());\n        this.messageSource = dms;\n        beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, this.messageSource);\n        if (logger.isTraceEnabled()) {\n            logger.trace("No \'" + MESSAGE_SOURCE_BEAN_NAME + "\' bean, using [" + this.messageSource + "]");\n        }\n    }\n}\n')),(0,a.kt)("h4",{id:"32-\u521d\u59cb\u5316\u5e7f\u64ad\u5668"},"3.2. \u521d\u59cb\u5316\u5e7f\u64ad\u5668"),(0,a.kt)("p",null,"\u8fd9\u4e00\u6b65\u5bf9\u5e94 ",(0,a.kt)("inlineCode",{parentName:"p"},"initApplicationEventMulticaster")," \u65b9\u6cd5\uff0c\u6ca1\u5565\u597d\u8bf4\u7684\uff0c\u5c31\u662f\u68c0\u67e5\u5f53\u524d ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory")," \u5bb9\u5668\u91cc\u9762\u6709\u6ca1\u6709\u540d\u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},"applicationEventMulticaster")," \u4e14\u7c7b\u578b\u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationEventMulticaster")," \u7684 Bean\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5982\u679c\u6709\uff0c\u5c31\u628a\u8be5\u5e7f\u64ad\u5668\u8bbe\u7f6e\u4e3a\u5f53\u524d\u5bb9\u5668\u7684\u9ed8\u8ba4\u5e7f\u64ad\u5668\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u5982\u679c\u6ca1\u6709\uff0c\u5c31\u521b\u5efa\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"li"},"SimpleApplicationEventMulticaster"),"\uff0c\u7136\u540e\u5c06\u5176\u6ce8\u518c\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"BeanFactory"),"\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'public static final String APPLICATION_EVENT_MULTICASTER_BEAN_NAME = "applicationEventMulticaster";\n\nprotected void initApplicationEventMulticaster() {\n    ConfigurableListableBeanFactory beanFactory = getBeanFactory();\n    // \u83b7\u53d6\u5df2\u6709\u7684\u5e7f\u64ad\u5668\n    if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) {\n        this.applicationEventMulticaster =\n                beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);\n        if (logger.isTraceEnabled()) {\n            logger.trace("Using ApplicationEventMulticaster [" + this.applicationEventMulticaster + "]");\n        }\n    }\n    else {\n        // \u5982\u679c\u6ca1\u6709\u5e7f\u64ad\u5668\uff0c\u5c31\u65b0\u5efa\u4e00\u4e2a\uff0c\u7136\u540e\u6ce8\u518c\u5230\u5bb9\u5668\n        this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory);\n        beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster);\n        if (logger.isTraceEnabled()) {\n            logger.trace("No \'" + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + "\' bean, using " +\n                    "[" + this.applicationEventMulticaster.getClass().getSimpleName() + "]");\n        }\n    }\n}\n')),(0,a.kt)("h4",{id:"33-\u6ce8\u518c\u76d1\u542c\u5668"},"3.3. \u6ce8\u518c\u76d1\u542c\u5668"),(0,a.kt)("p",null,"\u8fd9\u4e00\u6b65\u5bf9\u5e94 ",(0,a.kt)("inlineCode",{parentName:"p"},"registerListeners")," \u65b9\u6cd5\uff0c\u7b80\u5355\u7684\u6765\u8bf4\uff0c\u5c31\u662f\u83b7\u53d6\u5f53\u524d ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory")," \u4e2d\u6240\u6709\u5b9e\u73b0\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"ApplicationListener")," \u63a5\u53e3\u7684 Bean\uff0c\u7136\u540e\u5c06\u5176\u6ce8\u518c\u5230\u5e7f\u64ad\u5668\u4e2d\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"protected void registerListeners() {\n    // \u5411\u4e8b\u4ef6\u5e7f\u64ad\u5668\u6ce8\u518c\u5df2\u7ecf\u88ab\u6ce8\u518c\u7684\u4e0a\u4e0b\u6587\u4e2d\u7684\u76d1\u542c\u5668\n    for (ApplicationListener<?> listener : getApplicationListeners()) {\n        getApplicationEventMulticaster().addApplicationListener(listener);\n    }\n\n    // \u5411\u4e8b\u4ef6\u5e7f\u64ad\u5668\u6ce8\u518c\u6307\u5b9a\u7684\u76d1\u542c\u5668\uff0c\u4e0d\u8fc7\u8fd9\u91cc\u53ea\u6ce8\u518cBeanName\uff0c\n    // \u56e0\u4e3a\u6709\u4e9b\u76d1\u542c\u5668Bean\u662f\u7531FactoryBean\u751f\u4ea7\u7684\uff0c\u800c\u5728\u8fd9\u91ccFactoryBean\u5b9e\u9645\u4e0a\u8fd8\u6ca1\u88ab\u751f\u6210\u51fa\u6765\n    String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false);\n    for (String listenerBeanName : listenerBeanNames) {\n        getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);\n    }\n\n    // \u53d1\u5e03\u4e00\u4e9b\u65e9\u671f\u4e8b\u4ef6\n    Set<ApplicationEvent> earlyEventsToProcess = this.earlyApplicationEvents;\n    this.earlyApplicationEvents = null;\n    if (!CollectionUtils.isEmpty(earlyEventsToProcess)) {\n        for (ApplicationEvent earlyEvent : earlyEventsToProcess) {\n            getApplicationEventMulticaster().multicastEvent(earlyEvent);\n        }\n    }\n}\n")),(0,a.kt)("p",null,"\u9700\u8981\u6ce8\u610f\u7684\u662f\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u6ce8\u518c\u7684\u662f BeanName \u800c\u4e0d\u662f\u76f4\u63a5\u6ce8\u518c Bean")," \uff1a\u4e3a\u4e86\u5c3d\u53ef\u80fd\u7684\u5ef6\u8fdf Bean \u7684\u52a0\u8f7d\uff0c\u56e0\u6b64\u5e7f\u64ad\u5668\u53ea\u6709\u7b49\u5230\u8981\u68c0\u7d22\u76d1\u542c\u5668\u7684\u65f6\u5019\u624d\u4f1a\u5c1d\u8bd5\u6839\u636e beanName \u521b\u5efa\u5e76\u83b7\u53d6\u76d1\u542c\u5668 Bean\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u53ea\u6ce8\u518c\u7f16\u7a0b\u5f0f\u76d1\u542c\u5668"),"\uff1a\u8fd9\u91cc\u53ea\u6ce8\u518c\u4e86\u76f4\u63a5\u5b9e\u73b0 ",(0,a.kt)("inlineCode",{parentName:"li"},"ApplicationListener")," \u63a5\u53e3\u7684\u7f16\u7a0b\u5f0f\u76d1\u542c\u5668\u3002\u57fa\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"@EventListener")," \u6ce8\u89e3\u7684\u58f0\u660e\u5f0f\u76d1\u542c\u5668\u7684\u6ce8\u518c\u65f6\u673a\u66f4\u665a\uff0c\u9700\u8981\u7b49\u5230\u5b9e\u4f8b\u5316\u6240\u6709\u975e\u5355\u4f8b Bean \u65f6\u624d\u4f1a\u5b8c\u6210\u6ce8\u518c\u3002")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u5173\u4e8e\u58f0\u660e\u5f0f\u76d1\u542c\u5668\uff0c\u8bf7\u53c2\u89c1\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://www.yuque.com/magestack/open8gu/ibiy1ayhp4ufhs9x?view=doc_embed"},"\u4ec0\u4e48\u662f\u58f0\u660e\u5f0f\u76d1\u542c\u5668\uff1f"))),(0,a.kt)("h3",{id:"4-\u9884\u52a0\u8f7d\u6240\u6709\u5355\u4f8b-bean"},"4. \u9884\u52a0\u8f7d\u6240\u6709\u5355\u4f8b Bean"),(0,a.kt)("p",null,"\u8fd9\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u4e00\u6b65\uff0c\u5728\u6240\u6709\u57fa\u672c\u7ec4\u4ef6\u90fd\u5b8c\u6210\u521d\u59cb\u5316\u540e\uff0cSpring \u4f1a\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"finishBeanFactoryInitialization")," \u8fd9\u4e00\u6b65\u52a0\u8f7d\u6240\u6709\u7684\u975e\u61d2\u52a0\u8f7d\u7684\u5355\u4f8b Bean\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {\n    // \u4e3aBeanFactory\u8bbe\u7f6eConversionService\n    // \u8be5\u63a5\u53e3\u4e3aspring\u8f6c\u6362\u5668\u4f53\u7cfb\u7684\u5165\u53e3\n    if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &&\n        beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) {\n        beanFactory.setConversionService(\n            beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));\n    }\n\n    // \u6ce8\u518c\u4e00\u4e2aStringValueResolver\uff0c\u6ca1\u6709\u5c31\u4ece\u4e0a\u4e0b\u6587\u7684\u73af\u5883\u5bf9\u8c61\u4e2d\u83b7\u53d6\n    // \u8be5\u89e3\u6790\u5668\u7528\u4e8e\u89e3\u6790\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u4e00\u4e9b\u5360\u4f4d\u7b26\u4ee5\u53caSpEL\u8868\u8fbe\u5f0f\n    if (!beanFactory.hasEmbeddedValueResolver()) {\n        beanFactory.addEmbeddedValueResolver(strVal -> getEnvironment().resolvePlaceholders(strVal));\n    }\n\n    // \u82e5\u5b58\u5728AOP\u4f7f\u7528\u7684\u652f\u6301\u7c7b\u52a0\u8f7d\u65f6\u7ec7\u5165\u5207\u9762\u903b\u8f91\u7684\u7c7b\u52a0\u8f7d\u5668\uff0c\u5219\u4f18\u5148\u5c06\u8be5Bean\u521d\u59cb\u5316\n    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false);\n    for (String weaverAwareName : weaverAwareNames) {\n        getBean(weaverAwareName);\n    }\n\n    // \u7531\u4e8e\u7c7b\u52a0\u8f7d\u5668\u5df2\u7ecf\u521d\u59cb\u5316\u5b8c\u6210\uff0c\u6240\u4ee5\u53ef\u4ee5\u505c\u7528\u4e34\u65f6\u7684\u7c7b\u52a0\u8f7d\u5668\u4e86\n    beanFactory.setTempClassLoader(null);\n\n    // \u9501\u5b9a\u5f53\u524d\u5de5\u5382\u7684\u914d\u7f6e\n    beanFactory.freezeConfiguration();\n\n    // \u521d\u59cb\u5316\u5269\u4f59\u672a\u521d\u59cb\u5316\u7684\u975e\u61d2\u52a0\u8f7d\u5355\u4f8bBean\n    beanFactory.preInstantiateSingletons();\n}\n")),(0,a.kt)("p",null,"\u8fd9\u91cc\u6211\u4eec\u91cd\u70b9\u5173\u6ce8 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory.preInstantiateSingletons()")," \u65b9\u6cd5\uff0c\u6b64\u5904\u662f\u5b9e\u9645\u4e0a\u5b8c\u6210 ",(0,a.kt)("inlineCode",{parentName:"p"},"Bean")," \u521d\u59cb\u5316\u7684\u4ee3\u7801\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'public void preInstantiateSingletons() throws BeansException {\n    if (logger.isTraceEnabled()) {\n        logger.trace("Pre-instantiating singletons in " + this);\n    }\n\n    // Iterate over a copy to allow for init methods which in turn register new bean definitions.\n    // While this may not be part of the regular factory bootstrap, it does otherwise work fine.\n    List<String> beanNames = new ArrayList<>(this.beanDefinitionNames);\n\n    // \u904d\u5386beanName\uff0c\u82e5BeanName\u662f\u53ef\u4ee5\u5b9e\u4f8b\u5316\u7684\u975e\u61d2\u52a0\u8f7d\u5355\u4f8bBean\uff0c\u5219\u5c06\u5176\u5b9e\u4f8b\u5316\n    for (String beanName : beanNames) {\n        RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);\n        if (!bd.isAbstract() && bd.isSingleton() && !bd.isLazyInit()) {\n            // \u5982\u679c\u662fFactoryBean\n            if (isFactoryBean(beanName)) {\n                Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);\n                if (bean instanceof FactoryBean) {\n                    FactoryBean<?> factory = (FactoryBean<?>) bean;\n                    boolean isEagerInit;\n                    // \u7c7b\u578b\u4e3aSmartFactoryBean\uff0c\u5219\u662f\u5426\u7acb\u523b\u5b9e\u4f8b\u5316\u7531SmartFactoryBean.isEagerInit()\u51b3\u5b9a\n                    if (System.getSecurityManager() != null && factory instanceof SmartFactoryBean) {\n                        isEagerInit = AccessController.doPrivileged(\n                            (PrivilegedAction<Boolean>) ((SmartFactoryBean<?>) factory)::isEagerInit,\n                            getAccessControlContext());\n                    }\n                    else {\n                    // \u7c7b\u578b\u4e0d\u4e3aSmartFactoryBean\uff0c\u5219\u4e0d\u7acb\u523b\u5b9e\u4f8b\u5316\n                        isEagerInit = (factory instanceof SmartFactoryBean &&\n                                       ((SmartFactoryBean<?>) factory).isEagerInit());\n                    }\n                    if (isEagerInit) {\n                        getBean(beanName);\n                    }\n                }\n            }\n            else {\n                // \u5b9e\u4f8b\u5316bean\n                getBean(beanName);\n            }\n        }\n    }\n\n    // \u83b7\u53d6\u6240\u6709\u5b9e\u73b0\u4e86SmartInitializingSingleton\u63a5\u53e3\u7684Bean\uff0c\u8c03\u7528Bean\u521d\u59cb\u5316\u540e\u56de\u8c03afterSingletonsInstantiated\n    for (String beanName : beanNames) {\n        Object singletonInstance = getSingleton(beanName);\n        if (singletonInstance instanceof SmartInitializingSingleton) {\n            SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;\n            if (System.getSecurityManager() != null) {\n                AccessController.doPrivileged((PrivilegedAction<Object>) () -> {\n                    smartSingleton.afterSingletonsInstantiated();\n                    return null;\n                }, getAccessControlContext());\n            }\n            else {\n                smartSingleton.afterSingletonsInstantiated();\n            }\n        }\n    }\n}\n')),(0,a.kt)("p",null,"\u7b80\u5355\u7684\u6765\u8bf4\uff0c\u8fd9\u4e00\u6b65\u4e3b\u8981\u5e72\u4e86\u4e24\u4ef6\u4e8b\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u5224\u65ad\u662f\u5426\u5355\u4f8b Bean"),"\uff1a\u662f\u5c31\u52a0\u8f7d\uff0c\u4e0d\u662f\u5c31\u653e\u5f03\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"\u5224\u65ad\u662f\u5426\u5355\u4f8b\u7684 FactorBean"),"\uff1a",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u5982\u679c\u4e0d\u662f\uff0c\u5219\u653e\u5f03\u76f4\u63a5\u521d\u59cb\u5316\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u5982\u679c\u662f\uff0c\u5219\u68c0\u67e5\u662f\u5426\u662f ",(0,a.kt)("inlineCode",{parentName:"li"},"SmartFactoryBean"),"\uff0c\u5982\u679c\u662f\u5c31\u6839\u636e ",(0,a.kt)("inlineCode",{parentName:"li"},"SmartFactoryBean.isEagerInit()")," \u5224\u65ad\u662f\u5426\u8981\u76f4\u63a5\u521d\u59cb\u5316\uff0c\u5426\u5219\u653e\u5f03\u521d\u59cb\u5316\u3002")))),(0,a.kt)("p",null,"\u5f53\u521d\u59cb\u5316\u5b8c\u6bd5\u540e\uff0cSpring \u8fd8\u4f1a\u68c0\u67e5\u8fd9\u4e9b ",(0,a.kt)("inlineCode",{parentName:"p"},"Bean")," \u662f\u5426\u5b9e\u73b0\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"SmartInitializingSingleton")," \u63a5\u53e3\uff0c\u5982\u679c\u662f\u5219\u8c03\u7528\u8be5\u63a5\u53e3\u63d0\u4f9b\u7684\u56de\u8c03\u51fd\u6570\u3002"),(0,a.kt)("p",null,"\u81f3\u6b64\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory")," \u4e2d\u6240\u6709\u53ef\u4ee5\u9884\u5148\u521d\u59cb\u5316\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"Bean")," \u90fd\u5b8c\u6210\u7684\u521d\u59cb\u5316\uff0c\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"BeanFactory")," \u6b63\u5e38\u7684\u53bb\u83b7\u53d6 ",(0,a.kt)("inlineCode",{parentName:"p"},"Bean")," \u4e86\u3002"),(0,a.kt)("blockquote",null,(0,a.kt)("ul",{parentName:"blockquote"},(0,a.kt)("li",{parentName:"ul"},"\u5173\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"FactoryBean"),"\uff0c\u8bf7\u53c2\u89c1\uff1a",(0,a.kt)("a",{parentName:"li",href:"/framework/spring/dhzlrik2ylop354g"},"\u2705 \u4ec0\u4e48\u662f FactoryBean\uff1f")),(0,a.kt)("li",{parentName:"ul"},"\u5b9e\u9645\u4e0a\u521b\u5efa Bean \u7684\u903b\u8f91\u4f9d\u7136\u8fd8\u662f\u57fa\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"getBean")," \u5b9e\u73b0\u7684\uff0c\u5173\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"getBean")," \u7684\u5e95\u5c42\u539f\u7406\u4e0e Bean \u7684\u751f\u547d\u5468\u671f\uff0c\u53ef\u4ee5\u53c2\u89c1\uff1a",(0,a.kt)("a",{parentName:"li",href:"/framework/spring/cssibafmgio4g44c"},"\u2705 Bean \u7684\u751f\u547d\u5468\u671f\uff1f")))),(0,a.kt)("h3",{id:"5-\u5b8c\u6210\u5237\u65b0"},"5. \u5b8c\u6210\u5237\u65b0"),(0,a.kt)("p",null,"\u5728\u4e00\u5207\u7684\u672b\u5c3e\uff0cSpring \u5c06\u4f1a\u8c03\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"finishRefresh")," \u65b9\u6cd5\u771f\u6b63\u7684\u5b8c\u6210\u5237\u65b0\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"protected void finishRefresh() {\n    // \u6e05\u7a7a\u8d44\u6e90\u7f13\u5b58\n    clearResourceCaches();\n\n    // \u521d\u59cb\u5316\u4e0a\u4e0b\u6587\u7684\u751f\u547d\u5468\u671f\u5904\u7406\u5668\n    initLifecycleProcessor();\n\n    // \u8c03\u7528\u4e0a\u4e0b\u6587\u7684\u751f\u547d\u5468\u671f\u5904\u7406\u5668\n    getLifecycleProcessor().onRefresh();\n\n    // \u53d1\u5e03\u4e0a\u4e0b\u6587\u5237\u65b0\u5b8c\u6bd5\u4e8b\u4ef6\n    publishEvent(new ContextRefreshedEvent(this));\n\n    // \u6ce8\u518c\u7528\u4e8e\u652f\u6301\u901a\u8fc7JMX\u7ba1\u7406spring\u7684\u7ec4\u4ef6\uff0c\u8fd9\u91cc\u4e0d\u8fc7\u591a\u5206\u6790\uff0c\n    // \u5173\u4e8eJMX\u5177\u4f53\u53ef\u4ee5\u53c2\u8003\u8fd9\u7bc7\u6587\u7ae0\uff1ahttps://www.wdbyte.com/java/jmx.html#_3-2-%E8%B5%84%E6%BA%90%E4%BB%A3%E7%90%86-mbean-server\n    LiveBeansView.registerApplicationContext(this);\n}\n")),(0,a.kt)("p",null,"\u5728\u8fd9\u4e2a\u65b9\u6cd5\u4e2d\uff0c\u4e3b\u8981\u505a\u4e86\u4e09\u4ef6\u4e8b\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u6e05\u7a7a\u6240\u6709\u8d44\u6e90\u7f13\u5b58\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u89e6\u53d1\u4e0a\u4e0b\u6587\u7684\u751f\u547d\u5468\u671f\u56de\u8c03\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u53d1\u5e03 ContextRefreshedEvent \u4e8b\u4ef6\u3002")),(0,a.kt)("p",null,"\u6b64\u5916\uff0c\u5728 Web \u73af\u5883\u4e2d\uff0cSpring \u8fd8\u4f1a\u5728\u8fd9\u65f6\u542f\u52a8\u5185\u7f6e\u7684 Web \u5bb9\u5668\u3002"),(0,a.kt)("h4",{id:"51-\u6e05\u7a7a\u4e0a\u4e0b\u6587\u8d44\u6e90\u7f13\u5b58"},"5.1. \u6e05\u7a7a\u4e0a\u4e0b\u6587\u8d44\u6e90\u7f13\u5b58"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"public void clearResourceCaches() {\n    this.resourceCaches.clear();\n}\n")),(0,a.kt)("h4",{id:"52-\u89e6\u53d1\u4e0a\u4e0b\u6587\u7684\u751f\u547d\u5468\u671f\u56de\u8c03"},"5.2. \u89e6\u53d1\u4e0a\u4e0b\u6587\u7684\u751f\u547d\u5468\u671f\u56de\u8c03"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'protected void initLifecycleProcessor() {\n    ConfigurableListableBeanFactory beanFactory = getBeanFactory();\n    // \u82e5\u5b58\u5728\u540d\u4e3a\u201clifecycleProcessor\u201d\u7684bean\uff0c\u5219\u8bbe\u7f6e\u4e3a\u751f\u547d\u5468\u671f\u5904\u7406\u5668\n    if (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) {\n        this.lifecycleProcessor =\n            beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);\n        if (logger.isTraceEnabled()) {\n            logger.trace("Using LifecycleProcessor [" + this.lifecycleProcessor + "]");\n        }\n    }\n    // \u82e5\u4e0d\u5b58\u5728\u540d\u4e3a\u201clifecycleProcessor\u201d\u7684bean\uff0c\u5219\u521b\u5efa\u4e00\u4e2aDefaultLifecycleProcessor\u5e76\u8bbe\u7f6e\u4e3a\u751f\u547d\u5468\u671f\u5904\u7406\u5668\n    else {\n        DefaultLifecycleProcessor defaultProcessor = new DefaultLifecycleProcessor();\n        defaultProcessor.setBeanFactory(beanFactory);\n        this.lifecycleProcessor = defaultProcessor;\n        beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, this.lifecycleProcessor);\n        if (logger.isTraceEnabled()) {\n            logger.trace("No \'" + LIFECYCLE_PROCESSOR_BEAN_NAME + "\' bean, using " +\n                         "[" + this.lifecycleProcessor.getClass().getSimpleName() + "]");\n        }\n    }\n}\n')),(0,a.kt)("p",null,"\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"getLifecycleProcessor().onRefresh()")," \u8fd9\u4e00\u6b65\uff0c\u5c06\u4f1a\u83b7\u53d6\u4e0a\u4e00\u6b65\u8bbe\u7f6e\u5230\u4e0a\u4e0b\u6587\u4e2d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"LifecycleProcessor")," \u7136\u540e\u8c03\u7528\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'// AbstraceApplicationContext.getLifecycleProcessor()\nLifecycleProcessor getLifecycleProcessor() throws IllegalStateException {\n    if (this.lifecycleProcessor == null) {\n        throw new IllegalStateException("LifecycleProcessor not initialized - " +\n                                        "call \'refresh\' before invoking lifecycle methods via the context: " + this);\n    }\n    return this.lifecycleProcessor;\n}\n')),(0,a.kt)("p",null,"\u8fd9\u91cc\u6211\u4eec\u4ee5\u9ed8\u8ba4\u7684\u751f\u547d\u5468\u671f\u5904\u7406\u5668 ",(0,a.kt)("inlineCode",{parentName:"p"},"DefaultLifecycleProcessor")," \u4e3a\u4f8b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"@Override\npublic void onRefresh() {\n    startBeans(true);\n    this.running = true;\n}\n\nprivate void startBeans(boolean autoStartupOnly) {\n    // \u83b7\u53d6\u6240\u6709\u5b9e\u73b0\u4e86Lifecycle\u63a5\u53e3\u7684Bean\uff0c\u5e76\u6309\u9636\u6bb5\u5206\u7ec4\u88c5\u5230\u4e0d\u540c\u7684LifecycleGroup\u91cc\n    Map<String, Lifecycle> lifecycleBeans = getLifecycleBeans();\n    Map<Integer, LifecycleGroup> phases = new HashMap<>();\n    lifecycleBeans.forEach((beanName, bean) -> {\n        // \u540c\u65f6\u6ee1\u8db3\u4e0b\u8ff0\u6761\u4ef6\u7684Bean\u4e0d\u4f1a\u88ab\u5904\u7406\n        // 1.\u5165\u53c2\u7684autoStartupOnly\u4e3atrue\n        // 2.bean\u5b9e\u73b0\u4e86SmartLifecycle\u63a5\u53e3\n        // 3.SmartLifecycle.isAutoStartup()\u65b9\u6cd5\u8fd4\u56defalse\n        if (!autoStartupOnly || (bean instanceof SmartLifecycle && ((SmartLifecycle) bean).isAutoStartup())) {\n            // \u82e5\u5b9e\u73b0\u4e86SmartLifecycle\u63a5\u53e3\uff0c\u5219\u8fd4\u56deSmartLifecycle.getPhase()\uff0c\u5426\u5219\u9ed8\u8ba4\u8fd4\u56de0\n            int phase = getPhase(bean); \n            LifecycleGroup group = phases.get(phase);\n            if (group == null) {\n                group = new LifecycleGroup(phase, this.timeoutPerShutdownPhase, lifecycleBeans, autoStartupOnly);\n                phases.put(phase, group);\n            }\n            group.add(beanName, bean);\n        }\n    });\n    \n    // \u6309\u9636\u6bb5\u4ece\u5c0f\u5230\u5927\u6392\u5e8f\uff0c\u4f9d\u6b21\u5904\u7406\n    if (!phases.isEmpty()) {\n        List<Integer> keys = new ArrayList<>(phases.keySet());\n        Collections.sort(keys);\n        for (Integer key : keys) {\n            phases.get(key).start();\n        }\n    }\n}\n")),(0,a.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u9488\u5bf9 ",(0,a.kt)("inlineCode",{parentName:"p"},"SmartLifecycle")," \u63a5\u53e3\u7684\u5b9e\u73b0\u7c7b\u505a\u4e86\u5f88\u591a\u7279\u6b8a\u5316\u7684\u5904\u7406\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c Bean\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u6ca1\u6709\u5b9e\u73b0 ",(0,a.kt)("inlineCode",{parentName:"li"},"SmartLifecycle")," \u63a5\u53e3\uff0c\u5219\u76f4\u63a5\u8fdb\u884c\u5904\u7406\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u5b9e\u73b0\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"SmartLifecycle")," \u63a5\u53e3\uff0c\u5219\u6839\u636e ",(0,a.kt)("inlineCode",{parentName:"li"},"isAutoStartup")," \u65b9\u6cd5\u51b3\u5b9a\u662f\u5426\u8981\u8fdb\u884c\u5904\u7406\u3002")),(0,a.kt)("p",null,"\u6b64\u5916\uff0c\u5728\u5904\u7406 Bean \u7684\u65f6\u5019\uff0c\u8fd8\u4f1a",(0,a.kt)("strong",{parentName:"p"},"\u6839\u636e\u201cPhase\u201d\u6309\u987a\u5e8f\u4ece\u5c0f\u5230\u5927\u6392\u5e8f"),"\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u6ca1\u5b9e\u73b0 ",(0,a.kt)("inlineCode",{parentName:"li"},"SmartLifecycle")," \u63a5\u53e3\uff0c\u5219\u6700\u4f18\u5148\u88ab\u5904\u7406\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u5b9e\u73b0\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"SmartLifecycle")," \u63a5\u53e3\uff0c\u6839\u636e ",(0,a.kt)("inlineCode",{parentName:"li"},"getPhase")," \u7684\u8fd4\u56de\u503c\u4ece\u5c0f\u5230\u5927\u4f9d\u6b21\u5904\u7406\u3002")),(0,a.kt)("h4",{id:"53-\u53d1\u5e03-contextrefreshedevent-\u4e8b\u4ef6"},"5.3. \u53d1\u5e03 ContextRefreshedEvent \u4e8b\u4ef6"),(0,a.kt)("p",null,"\u8fd9\u4e2a\u64cd\u4f5c\u5176\u5b9e\u4e5f\u5f88\u7b80\u5355\uff0c\u5176\u5b9e\u5c31\u662f\u8c03\u7528\u65f6\u95f4\u5e7f\u64ad\u5668\u63a8\u9001\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"p"},"ContextRefreshedEvent")," \u4e8b\u4ef6\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"public class ContextRefreshedEvent extends ApplicationContextEvent {\n    public ContextRefreshedEvent(ApplicationContext source) {\n        super(source);\n    }\n}\n")),(0,a.kt)("h4",{id:"54-\u542f\u52a8-webserver"},"5.4. \u542f\u52a8 WebServer"),(0,a.kt)("p",null,"\u5728 SpringBoot \u4e2d\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"ServletWebServerApplicationContext"),"\u548c ",(0,a.kt)("inlineCode",{parentName:"p"},"ReactiveWebServerApplicationContext")," \u90fd\u91cd\u5199\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"finishRefresh")," \u65b9\u6cd5\uff0c",(0,a.kt)("strong",{parentName:"p"},"\u5b83\u4eec\u5728\u8fd9\u4e00\u6b65\u9664\u4e86\u5b8c\u6210\u4e0a\u8ff0\u4e09\u4e2a\u64cd\u4f5c\u5916\uff0c\u8fd8\u4f1a\u5728\u8fd9\u4e00\u6b65\u542f\u52a8\u5bf9\u5e94\u7684 Web \u670d\u52a1\u5668\u3002")),(0,a.kt)("p",null,"\u6211\u4eec\u4ee5\u6700\u5e38\u89c1\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"ServletWebServerApplicationContext")," \u4e3a\u4f8b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"@Override\nprotected void finishRefresh() {\n    super.finishRefresh();\n    WebServer webServer = startWebServer();\n    if (webServer != null) {\n        publishEvent(new ServletWebServerInitializedEvent(webServer, this));\n    }\n}\n\nprivate WebServer startWebServer() {\n    WebServer webServer = this.webServer;\n    if (webServer != null) {\n        webServer.start();\n    }\n    return webServer;\n}\n")),(0,a.kt)("p",null,"\u8fd9\u91cc\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"WebServer")," \u5b9e\u9645\u4e0a\u5c31\u662f\u6211\u4eec\u8bf4\u7684 SpringBoot \u5185\u5d4c\u7684 Web \u5bb9\u5668\uff0c\u5b83\u7684\u51e0\u4e2a\u5e38\u89c1\u5b9e\u73b0\u5982\u4e0b\uff1a"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://oss.open8gu.com/open8gu/c3525c53-7572-4ebd-a81e-7e0148a5a2f2",alt:"image.png"})),(0,a.kt)("p",null,"\u8fd9\u91cc\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"WebServer")," \u5b9e\u9645\u4e0a\u662f\u901a\u8fc7 Spring \u5bb9\u5668\u4e2d\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"ServletWebServerFactory"),"\u83b7\u53d6\u7684\uff0c\u800c ",(0,a.kt)("inlineCode",{parentName:"p"},"ServletWebServerFactory")," \u5219\u662f\u901a\u8fc7\u5bf9\u5e94\u662f starter \u4e2d\u7684\u914d\u7f6e\u7c7b\u5f15\u5165\u7684\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'protected ServletWebServerFactory getWebServerFactory() {\n    // Use bean names so that we don\'t consider the hierarchy\n    String[] beanNames = getBeanFactory().getBeanNamesForType(ServletWebServerFactory.class);\n    if (beanNames.length == 0) {\n        throw new ApplicationContextException("Unable to start ServletWebServerApplicationContext due to missing "\n                + "ServletWebServerFactory bean.");\n    }\n    if (beanNames.length > 1) {\n        throw new ApplicationContextException("Unable to start ServletWebServerApplicationContext due to multiple "\n                + "ServletWebServerFactory beans : " + StringUtils.arrayToCommaDelimitedString(beanNames));\n    }\n    return getBeanFactory().getBean(beanNames[0], ServletWebServerFactory.class);\n}\n')))}y.isMDXComponent=!0},9962:(e,n,t)=>{t.d(n,{ZP:()=>i});var r=t(7462),a=(t(7294),t(3905));const o={toc:[]},s="wrapper";function i(e){let{components:n,...t}=e;return(0,a.kt)(s,(0,r.Z)({},o,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u4f5c\u8005\uff1a\u7a0b\u5e8f\u5458\u9a6c\u4e01"),(0,a.kt)("p",null,"\u5728\u7ebf\u535a\u5ba2\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://open8gu.com"},"https://open8gu.com")),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"\u5927\u8bdd\u9762\u8bd5\uff0c\u6280\u672f\u540c\u5b66\u9762\u8bd5\u5fc5\u5907\u7684\u516b\u80a1\u6587\u5c0f\u518c\uff0c\u4ee5\u7cbe\u5f69\u56de\u7b54\u5e94\u5bf9\u6df1\u5ea6\u95ee\u9898\uff0c\u52a9\u529b\u4f60\u5728\u9762\u8bd5\u4e2d\u62ff\u4e2aoffer\u3002")))}i.isMDXComponent=!0}}]);